#!/usr/bin/env bash
set -euo pipefail

# Pre-commit hook: auto-format staged Terraform files

STAGED_TF_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.tf$' || true)

if [ -z "$STAGED_TF_FILES" ]; then
    exit 0
fi

echo "üîç Running terraform fmt on staged files..."

# Get unique directories containing staged .tf files
DIRS=$(echo "$STAGED_TF_FILES" | xargs -I{} dirname {} | sort -u)

for dir in $DIRS; do
    terraform fmt "$dir"
done

# Re-stage formatted files
echo "$STAGED_TF_FILES" | xargs git add

echo "‚úÖ Terraform formatting applied"
