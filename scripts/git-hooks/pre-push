#!/usr/bin/env bash
set -euo pipefail

# Pre-push hook: validate all Terraform modules

echo "üîç Validating Terraform modules..."

REPO_ROOT="$(git rev-parse --show-toplevel)"
ERRORS=0

for dir in "$REPO_ROOT"/modules/*/; do
    module_name=$(basename "$dir")
    echo "  Validating modules/$module_name..."
    if ! (cd "$dir" && terraform init -backend=false -input=false > /dev/null 2>&1 && terraform validate) ; then
        echo "  ‚úó modules/$module_name failed validation"
        ERRORS=$((ERRORS + 1))
    fi
done

if [ "$ERRORS" -gt 0 ]; then
    echo "‚ùå $ERRORS module(s) failed validation"
    exit 1
fi

echo "‚úÖ All modules validated successfully"
